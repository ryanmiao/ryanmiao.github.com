<!DOCTYPE html>
<html class="no-js" lang="en">
<head>
  <meta charset="utf-8">
  <title>Jade Palace</title>
  <meta name="author" content="Jincheng Miao">

  
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jinchengmiao.com">
  <link href="/favicon.png" type="image/png" rel="icon">
  <link href="/atom.xml" rel="alternate" title="Jade Palace" type="application/atom+xml">

  <!-- http://opengraphprotocol.org/ -->
  <meta name="twitter:card" content="summary_large_image">
  <meta property="og:type" content="website">
  <meta property="og:url" content="http://jinchengmiao.com">
  <meta property="og:title" content="Jade Palace">
  

  <script src="/javascripts/libs/jquery/jquery-2.0.3.min.js"></script>

<link href="/assets/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet" type="text/css">
<link href="/assets/bootstrap/dist/css/bootstrap-theme.min.css" rel="stylesheet" type="text/css">


  
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

  

</head>

  <body   >
    <div id="wrap">
      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">Jade Palace</a>
        </div>

        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li class="active">
                    <a rel="index" href="/">Blog</a>
                </li>
                <li >
                    <a href="/blog/archives">Archives</a>
                </li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <a class="subscribe-rss" href="/atom.xml" title="subscribe via RSS">
                        <span class="visible-xs">RSS</span>
                        <img class="hidden-xs" src="/images/rss.png" alt="RSS">
                    </a>
                </li>
                
            </ul>
            
                <form class="search navbar-form navbar-right" action="https://www.bing.com/search" method="GET">
                    <input type="hidden" name="q" value="site:jinchengmiao.com">
                    <div class="form-group">
                        <input class="form-control" type="text" name="q" placeholder="Search">
                    </div>
                </form>
            
        </div>
    </div>
</nav>


      </header>
      <div id="main" class="container">
        <div id="content">
          <div class="row">
  <div class="page-content col-md-9">
    <div class="blog-index" itemscope itemtype="http://schema.org/Blog">
    <meta itemprop="name" content="Jade Palace" />
    
    <meta itemprop="url" content="http://jinchengmiao.com" />
      
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-10-27T14:21:53+08:00"  data-updated="true" itemprop="datePublished dateCreated"><time class='entry-date' datetime='2014-10-27T14:21:53+08:00'><span class='date'><span class='date-month'>Oct</span> <span class='date-day'>27</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>2:21 pm</span></time></time>
        
           | <a href="/blog/2014/10/27/construct-virtualization-on-rhel6u5/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://jinchengmiao.com/blog/2014/10/27/construct-virtualization-on-rhel6u5/">Comments</a>
        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/2014/10/27/construct-virtualization-on-rhel6u5/" itemprop="url">Construct Virtualization on RHEL6u5</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>RHEL6u5 is stable distro for building a somewhat server. And if you also
like traditional SysV instead of systemD, this article gives you a guide
to construct virtualization from source on RHEL6u5.</p>

<h4>Prerequisite</h4>

<p>source code of kernel, qemu and libvirt</p>

<p>libiscsi: 1.11.0-9-g20b4f9a
libnfs:   libnfs-1.9.4-6-gea283cd
libusb:   v1.0.19</p>

<p>qemu:     v2.1.0-1124-gb1d28ec
kernel:   v3.18-rc1-221-gc3351df
libvirt:  v1.2.9-110-ga27021a</p>

<h4>1. Build kernel</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"></pre></td><td class='code'><pre><code class=''><span class='line'>#make bzImage
</span><span class='line'>#make modules
</span><span class='line'>#make modules_install
</span><span class='line'>#make install</span></code></pre></td></tr></table></div></figure>


<h4>2. BUild qemu</h4>

<h5>2.1 Build libiscsi, libusb and libnfs respectively</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"></pre></td><td class='code'><pre><code class=''><span class='line'>#git clone https://github.com/sahlberg/libiscsi.git
</span><span class='line'>#autogen
</span><span class='line'>#make
</span><span class='line'>#sudo make install
</span><span class='line'>
</span><span class='line'>#git clone https://github.com/libusb/libusb.git
</span><span class='line'>#autogen
</span><span class='line'>#make
</span><span class='line'>#sudo make install
</span><span class='line'>
</span><span class='line'>#git clone https://github.com/sahlberg/libnfs.git
</span><span class='line'>#bootstrap
</span><span class='line'>#make
</span><span class='line'>#sudo make install</span></code></pre></td></tr></table></div></figure>


<p>You have to set PKG_CONFIG_PATH to &lsquo;/usr/local/lib/pkgconfig&rsquo;
to continue configure.</p>

<h5>2.2 Generate qemu</h5>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"></pre></td><td class='code'><pre><code class=''><span class='line'># git clone https://github.com/qemu/qemu.git
</span><span class='line'>
</span><span class='line'># ./configure --target-list=x86_64-softmmu --enable-debug-tcg --enable-debug --disable-strip --enable-vnc --enable-vnc-tls --enable-kvm --enable-uuid --enable-attr --enable-vhost-net --enable-spice --enable-libiscsi --enable-libnfs --enable-libusb --enable-guest-agent --enable-glusterfs</span></code></pre></td></tr></table></div></figure>


<h4>3. Build libvirt</h4>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"></pre></td><td class='code'><pre><code class=''><span class='line'># autogen --system
</span><span class='line'># make
</span><span class='line'># make install</span></code></pre></td></tr></table></div></figure>


<h4>4. Troubleshoot</h4>

<h5>4.1 qemu: could not load PC BIOS &lsquo;bios-256k.bin&rsquo;</h5>

<p>Answer: don&rsquo;t specify prefix when configuring qemu, use default prefix instead.</p>

<h5>4.2 cannot execute binary /usr/libexec/qemu-kvm: Permission denied</h5>

<p>Answer: if SELinux is enabled, it may be caused by SELinux.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"></pre></td><td class='code'><pre><code class=''><span class='line'># chcon system_u:object_r:qemu_exec_t:s0 /usr/local/bin/qemu-system-x86_64</span></code></pre></td></tr></table></div></figure>


<p>[The end]</p>
</div>
  
  


        </article>
      
      
        <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
          
  <header class="page-header">
    
      <p class="meta text-muted text-uppercase">
        












<span class="glyphicon glyphicon-calendar"></span> <time datetime="2014-08-12T16:23:55+08:00"  data-updated="true" itemprop="datePublished dateCreated"><time class='entry-date' datetime='2014-08-12T16:23:55+08:00'><span class='date'><span class='date-month'>Aug</span> <span class='date-day'>12</span><span class='date-suffix'>th</span>, <span class='date-year'>2014</span></span> <span class='time'>4:23 pm</span></time></time>
        
           | <a href="/blog/2014/08/12/debugging-qemu-linux-user-mode-clone-syscall-emulation/#disqus_thread" itemprop="discussionUrl"
             data-disqus-identifier="http://jinchengmiao.com/blog/2014/08/12/debugging-qemu-linux-user-mode-clone-syscall-emulation/">Comments</a>
        
      </p>
    
    
      <h1 class="entry-title" itemprop="name headline"><a href="/blog/2014/08/12/debugging-qemu-linux-user-mode-clone-syscall-emulation/" itemprop="url">Debugging Qemu Linux User Mode Clone Syscall Emulation</a></h1>
    
  </header>


  <div class="entry-content clearfix" itemprop="articleBody description"><p>When I look into QEMU linux-user mode, I want to run a multi-thread program.
This multi-thread program is extracted from qemu/tests/tcg/linux-test.c.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"></pre></td><td class='code'><pre><code class=''><span class='line'>#include &lt;stdlib.h&gt;
</span><span class='line'>#include &lt;stdio.h&gt;
</span><span class='line'>#include &lt;string.h&gt;
</span><span class='line'>#include &lt;signal.h&gt;
</span><span class='line'>#include &lt;unistd.h&gt;
</span><span class='line'>#include &lt;inttypes.h&gt;
</span><span class='line'>#include &lt;pthread.h&gt;
</span><span class='line'>#include &lt;sys/wait.h&gt;
</span><span class='line'>#include &lt;sched.h&gt;
</span><span class='line'>
</span><span class='line'>int thread1_func(void *arg)
</span><span class='line'>{
</span><span class='line'>    int i;
</span><span class='line'>    char buf[512];
</span><span class='line'>
</span><span class='line'>    for(i=0;i&lt;10;i++) {
</span><span class='line'>        snprintf(buf, sizeof(buf), "thread1: %d %s\n", i, (char *)arg);
</span><span class='line'>       write(1, buf, strlen(buf));
</span><span class='line'>        usleep(100 * 1000);
</span><span class='line'>    }
</span><span class='line'>    return 0;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>int thread2_func(void *arg)
</span><span class='line'>{
</span><span class='line'>    int i;
</span><span class='line'>    char buf[512];
</span><span class='line'>    for(i=0;i&lt;10;i++) {
</span><span class='line'>        snprintf(buf, sizeof(buf), "thread2: %d %s\n", i, (char *)arg);
</span><span class='line'>        write(1, buf, strlen(buf));
</span><span class='line'>        usleep(120 * 1000);
</span><span class='line'>    }
</span><span class='line'>    return 0;
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>#define STACK_SIZE 16384
</span><span class='line'>
</span><span class='line'>void test_clone(void)
</span><span class='line'>{
</span><span class='line'>    uint8_t *stack1, *stack2;
</span><span class='line'>    int pid1, pid2, status1, status2;
</span><span class='line'>
</span><span class='line'>    stack1 = malloc(STACK_SIZE);
</span><span class='line'>    pid1 = clone(thread1_func, stack1 + STACK_SIZE,
</span><span class='line'>                 CLONE_VM | CLONE_FS | CLONE_FILES | SIGCHLD, "hello1");
</span><span class='line'>
</span><span class='line'>    stack2 = malloc(STACK_SIZE);
</span><span class='line'>    pid2 = clone(thread2_func, stack2 + STACK_SIZE,
</span><span class='line'>                CLONE_VM | CLONE_FS | CLONE_FILES | SIGCHLD, "hello2");
</span><span class='line'>
</span><span class='line'>    while (waitpid(pid1, &status1, 0) != pid1);
</span><span class='line'>    while (waitpid(pid2, &status2, 0) != pid2);
</span><span class='line'>    printf("status1=0x%x\n", status1);
</span><span class='line'>    printf("status2=0x%x\n", status2);
</span><span class='line'>    printf("End of clone test.\n");
</span><span class='line'>}
</span><span class='line'>
</span><span class='line'>int main(int argc, char **argv)
</span><span class='line'>{
</span><span class='line'>    test_clone();
</span><span class='line'>    return 0;
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>But when it runs, I get segv:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"></pre></td><td class='code'><pre><code class=''><span class='line'>$ ~/workspace/virt/qemu/x86_64-linux-user/qemu-x86_64 ./test-clone
</span><span class='line'>qemu-x86_64: /home/ryan/workspace/virt/qemu/tcg/tcg.c:628: tcg_temp_free_internal: Assertion `idx &gt;= s-&gt;nb_globals && idx &lt; s-&gt;nb_temps' failed.
</span><span class='line'>qemu: uncaught target signal 11 (Segmentation fault) - core dumped
</span><span class='line'>Segmentation fault (core dumped)</span></code></pre></td></tr></table></div></figure>


<p>It makes me frastrated, is it related to tcg?
Maybe, maybe not.</p>

<p>Debugging work is starting.</p>

<p>Firstly, I added &lsquo;-strace&rsquo; option to qemu-x86_64, this option will print
all syscall qemu emulated, and the return values:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"></pre></td><td class='code'><pre><code class=''><span class='line'>$ ~/workspace/virt/qemu/x86_64-linux-user/qemu-x86_64 -strace ./test-clone
</span><span class='line'>4459 uname(0x40007fffa0) = 0
</span><span class='line'>4459 brk(NULL) = 0x00000000006aa000
</span><span class='line'>4459 brk(0x00000000006ab180) = 0x00000000006ab180
</span><span class='line'>4459 arch_prctl(4098,6989920,0,6973864,6973856,6973888) = 0
</span><span class='line'>4459 brk(0x00000000006cc180) = 0x00000000006cc180
</span><span class='line'>4459 brk(0x00000000006cd000) = 0x00000000006cd000
</span><span class='line'>4459 clone(CLONE_VM|CLONE_FS|CLONE_FILES|0x11,child_stack=0x00000000006af860,parent_tidptr=0x00000000006a8068,tls=0x0000000000000001,child_tidptr=0x0000000000000001) = 4460
</span><span class='line'>4459 read(1809,0x6af860,6979688) = -1 errno=14 (Bad address)
</span><span class='line'>qemu-x86_64: /home/ryan/workspace/virt/qemu/tcg/tcg.c:628: tcg_temp_free_internal: Assertion `idx &gt;= s-&gt;nb_globals && idx &lt; s-&gt;nb_temps' failed.
</span><span class='line'>qemu: uncaught target signal 11 (Segmentation fault) - core dumped
</span><span class='line'>Segmentation fault (core dumped)</span></code></pre></td></tr></table></div></figure>


<p>Note: the first column is TID, I added this print in qemu_log():</p>

<p>But it doesn&rsquo;t give us some clue. A deeper check should be applied: check TB
(TranslationBlock) execution sequence.</p>

<p>A small patch to singlestep should be applied:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"></pre></td><td class='code'><pre><code class=''><span class='line'>diff --git a/cpu-exec.c b/cpu-exec.c
</span><span class='line'>index 38e5f02..64b7289 100644
</span><span class='line'>--- a/cpu-exec.c
</span><span class='line'>+++ b/cpu-exec.c
</span><span class='line'>@@ -622,8 +622,8 @@ int cpu_exec(CPUArchState *env)
</span><span class='line'>                 }
</span><span class='line'>                 /* see if we can patch the calling TB. When the TB
</span><span class='line'>                    spans two pages, we cannot safely do a direct
</span><span class='line'>-                   jump. */
</span><span class='line'>-                if (next_tb != 0 && tb-&gt;page_addr[1] == -1) {
</span><span class='line'>+                   jump. So as when singlestep is enabled. */
</span><span class='line'>+                if (next_tb != 0 && tb-&gt;page_addr[1] == -1 && !singlestep) {
</span><span class='line'>                     tb_add_jump((TranslationBlock *)(next_tb & ~TB_EXIT_MASK),
</span><span class='line'>                                 next_tb & TB_EXIT_MASK, tb);
</span><span class='line'>                 }
</span></code></pre></td></tr></table></div></figure>


<p>This small patch avoids TBs linked when singlestep is enabled.</p>

<p>After re-building qemu-x86_64, run:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"></pre></td><td class='code'><pre><code class=''><span class='line'>~/workspace/virt/qemu/x86_64-linux-user/qemu-x86_64 -singlestep -d exec -strace ./test-clone</span></code></pre></td></tr></table></div></figure>


<p>We can see that after clone executed, the child thread also executed a TB
(which tb->pc == 0x412de7):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"></pre></td><td class='code'><pre><code class=''><span class='line'>[4592] Trace 0x7f535879d0d0 [00000000004092e3] _int_malloc
</span><span class='line'>[4593] Trace 0x7f53587af860 [0000000000412de7] clone
</span><span class='line'>[4592] Trace 0x7f535879d110 [00000000004092e7] _int_malloc</span></code></pre></td></tr></table></div></figure>


<p>Let figure out what is it in 0x412de7. So objdump the test-clone:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"></pre></td><td class='code'><pre><code class=''><span class='line'>0000000000412db0 &lt;__clone&gt;:
</span><span class='line'>  412db0:       48 c7 c0 ea ff ff ff    mov    $0xffffffffffffffea,%rax
</span><span class='line'>  412db7:       48 85 ff                test   %rdi,%rdi
</span><span class='line'>  412dba:       0f 84 40 16 00 00       je     414400 &lt;__syscall_error&gt;
</span><span class='line'>  412dc0:       48 85 f6                test   %rsi,%rsi
</span><span class='line'>  412dc3:       0f 84 37 16 00 00       je     414400 &lt;__syscall_error&gt;
</span><span class='line'>  412dc9:       48 83 ee 10             sub    $0x10,%rsi
</span><span class='line'>  412dcd:       48 89 4e 08             mov    %rcx,0x8(%rsi)
</span><span class='line'>  412dd1:       48 89 3e                mov    %rdi,(%rsi)
</span><span class='line'>  412dd4:       48 89 d7                mov    %rdx,%rdi
</span><span class='line'>  412dd7:       4c 89 c2                mov    %r8,%rdx
</span><span class='line'>  412dda:       4d 89 c8                mov    %r9,%r8
</span><span class='line'>  412ddd:       4c 8b 54 24 08          mov    0x8(%rsp),%r10
</span><span class='line'>  412de2:       b8 38 00 00 00          mov    $0x38,%eax
</span><span class='line'>  412de7:       0f 05                   syscall
</span><span class='line'>  412de9:       48 85 c0                test   %rax,%rax
</span><span class='line'>  412dec:       0f 8c 0e 16 00 00       jl     414400 &lt;__syscall_error&gt;
</span><span class='line'>  412df2:       74 01                   je     412df5 &lt;__clone+0x45&gt;
</span><span class='line'>  412df4:       c3                      retq</span></code></pre></td></tr></table></div></figure>


<p>We could see the TB executed by child thread is syscall instruction,
here is the question why child thread also run clone syscall?</p>

<p>In linux-user/main.c:</p>

<figure class='code'><figcaption><span>linux-user/main.c </span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
</pre></td><td class='code'><pre><code class='c'><span class='line'><span class="cp">#ifndef TARGET_ABI32</span>
</span><span class='line'>        <span class="k">case</span> <span class="nl">EXCP_SYSCALL</span><span class="p">:</span>
</span><span class='line'>            <span class="cm">/* linux syscall from syscall instruction */</span>
</span><span class='line'>            <span class="n">env</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">R_EAX</span><span class="p">]</span> <span class="o">=</span> <span class="n">do_syscall</span><span class="p">(</span><span class="n">env</span><span class="p">,</span>
</span><span class='line'>                                          <span class="n">env</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">R_EAX</span><span class="p">],</span>
</span><span class='line'>                                          <span class="n">env</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">R_EDI</span><span class="p">],</span>
</span><span class='line'>                                          <span class="n">env</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">R_ESI</span><span class="p">],</span>
</span><span class='line'>                                          <span class="n">env</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">R_EDX</span><span class="p">],</span>
</span><span class='line'>                                          <span class="n">env</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">10</span><span class="p">],</span>
</span><span class='line'>                                          <span class="n">env</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span>
</span><span class='line'>                                          <span class="n">env</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span>
</span><span class='line'>                                          <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>            <span class="n">env</span><span class="o">-&gt;</span><span class="n">eip</span> <span class="o">=</span> <span class="n">env</span><span class="o">-&gt;</span><span class="n">exception_next_eip</span><span class="p">;</span>
</span><span class='line'>            <span class="k">break</span><span class="p">;</span>
</span><span class='line'><span class="cp">#endif</span>
</span></code></pre></td></tr></table></div></figure>


<p>The env->eip is updated to env->exception_next_eip, it seems too late for clone
syscall, because clone_func() will use that env->eip to start a new cpu_loop().
This is the bug, and causes segv.</p>

<p>For fix it, we could update env->eip before do_syscall().
And for consistent with &lsquo;INT 0x80&rsquo;, I choose to add logic to do_interrupt():</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"></pre></td><td class='code'><pre><code class='c'><span class='line'><span class="n">diff</span> <span class="o">--</span><span class="n">git</span> <span class="n">a</span><span class="o">/</span><span class="n">target</span><span class="o">-</span><span class="n">i386</span><span class="o">/</span><span class="n">seg_helper</span><span class="p">.</span><span class="n">c</span> <span class="n">b</span><span class="o">/</span><span class="n">target</span><span class="o">-</span><span class="n">i386</span><span class="o">/</span><span class="n">seg_helper</span><span class="p">.</span><span class="n">c</span>
</span><span class='line'><span class="n">index</span> <span class="mi">2</span><span class="n">d970d0</span><span class="p">.</span><span class="mf">.13</span><span class="n">eefba</span> <span class="mi">100644</span>
</span><span class='line'><span class="o">---</span> <span class="n">a</span><span class="o">/</span><span class="n">target</span><span class="o">-</span><span class="n">i386</span><span class="o">/</span><span class="n">seg_helper</span><span class="p">.</span><span class="n">c</span>
</span><span class='line'><span class="o">+++</span> <span class="n">b</span><span class="o">/</span><span class="n">target</span><span class="o">-</span><span class="n">i386</span><span class="o">/</span><span class="n">seg_helper</span><span class="p">.</span><span class="n">c</span>
</span><span class='line'><span class="err">@@</span> <span class="o">-</span><span class="mi">1127</span><span class="p">,</span><span class="mi">8</span> <span class="o">+</span><span class="mi">1127</span><span class="p">,</span><span class="mi">8</span> <span class="err">@@</span> <span class="k">static</span> <span class="kt">void</span> <span class="n">do_interrupt_user</span><span class="p">(</span><span class="n">CPUX86State</span> <span class="o">*</span><span class="n">env</span><span class="p">,</span> <span class="kt">int</span> <span class="n">intno</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_int</span><span class="p">,</span>
</span><span class='line'>
</span><span class='line'>     <span class="cm">/* Since we emulate only user space, we cannot do more than</span>
</span><span class='line'><span class="cm">        exiting the emulation with the suitable exception and error</span>
</span><span class='line'><span class="cm">-       code */</span>
</span><span class='line'><span class="o">-</span>    <span class="k">if</span> <span class="p">(</span><span class="n">is_int</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'><span class="o">+</span>       <span class="n">code</span><span class="p">.</span> <span class="n">So</span> <span class="n">update</span> <span class="n">EIP</span> <span class="k">for</span> <span class="n">INT</span> <span class="mh">0x80</span> <span class="n">and</span> <span class="n">EXCP_SYSCALL</span><span class="p">.</span> <span class="err">*/</span>
</span><span class='line'><span class="o">+</span>    <span class="k">if</span> <span class="p">(</span><span class="n">is_int</span> <span class="o">||</span> <span class="n">intno</span> <span class="o">==</span> <span class="n">EXCP_SYSCALL</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>         <span class="n">env</span><span class="o">-&gt;</span><span class="n">eip</span> <span class="o">=</span> <span class="n">next_eip</span><span class="p">;</span>
</span><span class='line'>     <span class="p">}</span>
</span><span class='line'> <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>After applying this patch, clone syscall will work.
This patch is merged into upstream: commit 47575997.</p>

<p>[The end]</p>
</div>
  
  


        </article>
      
    </div>

    <ul class="pager">
      
        <li class="previous disabled"><a href="#">&larr;&nbsp;Older</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
        <li class="next disabled"><a href="#">Newer&nbsp;&rarr;</a></li>
      
    </ul>
  </div>

  
    <aside class="sidebar col-md-3">
      
        <section class="panel panel-default">
  <div class="panel-heading">
    <h3 class="panel-title">Recent Posts</h3>
  </div>
  
  <div id="recent_posts" class="list-group">
    
    <a class="list-group-item " href="/blog/2014/10/27/construct-virtualization-on-rhel6u5/">Construct Virtualization on RHEL6u5</a>
    
    <a class="list-group-item " href="/blog/2014/08/12/debugging-qemu-linux-user-mode-clone-syscall-emulation/">Debugging Qemu Linux User Mode Clone Syscall Emulation</a>
    
  </div>
</section>




      
    </aside>
  
</div>

        </div>
      </div>
    </div>
    <footer role="contentinfo"><div class="container">
    <p class="text-muted credits">
  Copyright &copy; 2014 - Jincheng Miao<br>
  <small>
      <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>,
      <span class="credit">customized with <a href="https://github.com/kAworu/octostrap3">octostrap3</a></span>.
  </small>
</p>

</div>
</footer>
    

<script type="text/javascript">
      var disqus_shortname = 'jinchengmiao';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = ('https:' == document.location.protocol ? 'https://' : 'http://') + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>








<script src="/assets/bootstrap/dist/js/bootstrap.min.js"></script>
<script src="/javascripts/modernizr-2.0.js"></script>


  </body>
</html>
